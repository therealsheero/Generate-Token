<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Token Dashboard</title>

  <script>
    const token = localStorage.getItem("adminToken");
    if (!token) {
      window.location.href = "admin-login.html";
    }
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: lightyellow;
    }

    h2 {
      text-align: center;
      margin-bottom: 5px;
    }

    .note {
      font-size: 13px;
      color: #555;
      margin-bottom: 15px;
      text-align: center;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 13px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    tr.priority {
      background-color: #ffe6e6;
      font-weight: bold;
    }

    .actions {
      margin-bottom: 15px;
      text-align: center;
    }

    .actions button {
      padding: 8px 14px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 4px;
    }

    .logout {
      background: #dc2626;
    }
  </style>
</head>

<body>

<h2>ðŸŽ« Token Admin Dashboard</h2>

<p class="note">
  Showing <b>todayâ€™s tokens</b>. Priority tokens are highlighted.
</p>

<div class="actions">
  <button onclick="loadTokens()">ðŸ”„ Refresh</button>
  <button onclick="downloadCSV()">â¬‡ Download CSV</button>
  <button class="logout" onclick="logout()">ðŸšª Logout</button>
</div>

<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Token Number</th>
      <th>QRC</th>
      <th>Name</th>
      <th>Mobile</th>
      <th>District</th>
      <th>Service Type</th>
      <th>Gender</th>
      <th>Age</th>
      <th>PWD</th>
      <th>Priority</th>
    </tr>
  </thead>
  <tbody id="tokenTable">
    <tr><td colspan="11">Loading...</td></tr>
  </tbody>
</table>

<script>
async function loadTokens() {
  const table = document.getElementById("tokenTable");
  table.innerHTML = "<tr><td colspan='11'>Loading...</td></tr>";

  try {
    const res = await fetch(
      "http://localhost:5000/api/admin/today",
      {
        headers: {
          "x-admin-token": localStorage.getItem("adminToken")
        }
      }
    );

    const data = await res.json();

    if (!data.length) {
      table.innerHTML =
        "<tr><td colspan='11'>No tokens for today</td></tr>";
      return;
    }

    table.innerHTML = "";

    data.forEach(row => {
      const tr = document.createElement("tr");

      if (row.priority === "P") {
        tr.classList.add("priority");
      }

      tr.innerHTML = `
        <td>${row.date}</td>
        <td>${row.token}</td>
        <td>${row.qrc}</td>
        <td>${row.name}</td>
        <td>${row.mobile}</td>
        <td>${row.district}</td>
        <td>${row.service_type}</td>
        <td>${row.gender}</td>
        <td>${row.age}</td>
        <td>${row.divyang}</td>
        <td>${row.priority}</td>
      `;

      table.appendChild(tr);
    });

  } catch (e) {
    table.innerHTML =
      "<tr><td colspan='11'>Failed to load admin data</td></tr>";
  }
}

// âœ… SECURE CSV DOWNLOAD
async function downloadCSV() {
  try {
    const res = await fetch(
      "http://localhost:5000/api/admin/export-csv",
      {
        headers: {
          "x-admin-token": localStorage.getItem("adminToken")
        }
      }
    );

    if (!res.ok) {
      alert("Failed to download CSV");
      return;
    }

    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const today = new Date().toISOString().split("T")[0];
    const a = document.createElement("a");
    a.href = url;
    a.download = `tokens_${today}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    window.URL.revokeObjectURL(url);

  } catch {
    alert("CSV download error");
  }
}

// ðŸšª LOGOUT
function logout() {
  localStorage.removeItem("adminToken");
  window.location.href = "admin-login.html";
}

// auto-load
loadTokens();
</script>

</body>
</html>
