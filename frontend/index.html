<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Token Generation Portal / ‡§ü‡•ã‡§ï‡§® ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤</title>

  <link rel="stylesheet" href="css/style.css">

  <!-- ‚è∞ BOOKING TIME CHECK (RUNS FIRST) -->
  <script>
    function isWithinBookingTimeIST() {
      const now = new Date();
      const ist = new Date(
        now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" })
      );

      const minutes = ist.getHours() * 60 + ist.getMinutes();
      const start = 6 * 60; // 6:00 AM
      const end   = 18 * 60; // 6:00 PM

      return minutes >= start && minutes <= end;
    }
  </script>
</head>

<body>

<!-- üáÆüá≥ GOVERNMENT HEADER -->
<header class="gov-header">
  <div class="gov-left">
    <img src="assets/india-emblem.png" alt="Government of India Logo">
  </div>

  <div class="gov-center">
    <h1>Government of India / ‡§≠‡§æ‡§∞‡§§ ‡§∏‡§∞‡§ï‡§æ‡§∞</h1>
    <p>Appointment & Walk-in Token Management System</p>
  </div>

  <div class="gov-right">
    <img src="assets/Aadhaar_Small.png" alt="Department Logo">
  </div>
</header>

<h2 style="text-align:center;">
  Token Generation Portal / ‡§ü‡•ã‡§ï‡§® ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤
</h2>

<!-- üì¢ STATUS MESSAGE -->
<p id="locationStatus" style="text-align:center; font-weight:600;">
  ‚è≥ Checking booking availability...
</p>

<!-- üîò USER ACTION BUTTONS -->
<div style="text-align:center; margin-top:30px;">
  <button id="appointmentBtn" style="display:none;">
    üìÖ Book Appointment / ‡§Ö‡§™‡•â‡§á‡§Ç‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§¨‡•Å‡§ï ‡§ï‡§∞‡•á‡§Ç
  </button>

  <button id="walkinBtn" style="display:none;">
    üö∂ Generate Walk-in Token / ‡§µ‡•â‡§ï-‡§á‡§® ‡§ü‡•ã‡§ï‡§® ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
  </button>
</div>

<!-- üîê ADMIN LOGIN (ALWAYS ENABLED) -->
<div style="text-align:center; margin-top:25px;">
  <button id="adminLoginBtn"
          onclick="window.location.href='admin-login.html'">
    üîê Admin Login / ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§ï ‡§≤‡•â‡§ó‡§ø‡§®
  </button>
</div>

<!-- ============================= -->
<!-- üß† MAIN LOGIC -->
<!-- ============================= -->
<script>
  const statusEl = document.getElementById("locationStatus");
  const appointmentBtn = document.getElementById("appointmentBtn");
  const walkinBtn = document.getElementById("walkinBtn");

  // üö´ DISABLE USER BUTTONS (ADMIN NOT TOUCHED)
  function disableUserButtons() {
    [appointmentBtn, walkinBtn].forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = "0.6";
      btn.style.cursor = "not-allowed";
    });
  }

  // üìç LOCATION CHECK (ONLY IF TIME IS VALID)
  async function checkLocation() {
    if (!navigator.geolocation) {
      statusEl.innerText = "‚ùå Geolocation not supported";
      return;
    }

    statusEl.innerText = "üìç Checking your location...";

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        try {
          const res = await fetch("http://localhost:5000/api/location-check", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              latitude: pos.coords.latitude,
              longitude: pos.coords.longitude
            })
          });

          const data = await res.json();

          localStorage.setItem("distance_meters", data.distance_meters);

          statusEl.innerText =
            `üìç Distance from office: ${data.distance_meters} meters`;

          if (data.distance_meters <= 100) {
            walkinBtn.style.display = "inline-block";
          } else {
            appointmentBtn.style.display = "inline-block";
          }

        } catch {
          statusEl.innerText = "‚ùå Failed to verify location";
        }
      },
      () => {
        statusEl.innerText = "‚ùå Location permission denied";
      }
    );
  }

  // üîÄ BUTTON NAVIGATION
  appointmentBtn.onclick = () => {
    window.location.href = "appointment.html";
  };

  walkinBtn.onclick = () => {
    window.location.href = "walkin.html";
  };

  // üö¶ ENTRY POINT
  window.addEventListener("load", () => {
    if (!isWithinBookingTimeIST()) {
      statusEl.innerText =
        "Booking allowed only between 6:00 AM and 6:00 PM/ ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§ï‡•á‡§µ‡§≤ ‡§∏‡•Å‡§¨‡§π 6:00 ‡§¨‡§ú‡•á ‡§∏‡•á ‡§∂‡§æ‡§Æ 6:00 ‡§¨‡§ú‡•á ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§π‡•Ä ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§";

      disableUserButtons();
      return; // ‚õî STOP EVERYTHING (NO LOCATION CHECK)
    }

    // ‚úÖ Time valid ‚Üí now check location
    checkLocation();
  });
</script>

</body>
</html>
